<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <!-- Masonry -->
    <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
    <!-- Tile Functions -->
    <script type="text/javascript" src="{{url_for('static', filename='tile.js')}}"> </script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js" integrity="sha256-qXBd/EfAdjOA2FGrGAG+b3YBn2tn5A6bhz+LSgYD96k=" crossorigin="anonymous"></script>

    <title>MIX :: CS 240</title>
    <script>
      function getConnected() {
        $.get("/status")
        .done(function (data) {
          let g = _.groupBy(data, 'creator');

          html = "";

          for (let creator in g) {
            let IMs = g[creator];
            
            html += `<h2>${creator}</h2>`;
            html += `<ol>`;
            for (let im of IMs) {
              html += `<li>`
              html += `<b>${im.name}</b> @ ${im.ip} with ${im.dependencies.length} dependencies<br>`
              html += `<a href="javascript:MIX_urbana('${im.id}')">Urbana</a> `;
              html += `<a href="javascript:MIX_chicago('${im.id}')">Chicago</a> `;
              html += `<a href="javascript:MIX_sanfran('${im.id}')">San Francisco</a> `;
              html += `<a href="javascript:MIX_nyc('${im.id}')">New York City</a> `;
              html += `<a href="javascript:MIX_paris('${im.id}')">Paris (France)</a> `;
              html += `<a href="javascript:MIX_shenzhen('${im.id}')">Shenzhen (China)</a> `;
              html += `<a href="javascript:MIX_ocean('${im.id}')">Pacific Ocean</a>`;
              html += `<div id=${im.id}></div>`
              html += `</li>`;
            }
            html += `</ol>`;

            $("#connected").html(html);
          }
        })
        .fail(function (data) {
            $("#connected").html(JSON.stringify(data, null, 2));
        })
      }

      function MIX(location, coords, id) {
        let formData = { location: coords, id: id };

        $.post("/MIX-single", formData)
        .done(function (data) {
          let cache = "";
          if (data["_cache"] && data["_cache"] == "hit") {
            cache = ` <span style="color: green">CACHE HIT</span>`;
            delete data["_cache"];
          }

          let metadata = "";
          if (data["_metadata"]) {
            metadata = `<div style="color: grey; font-size: 10px;">${JSON.stringify(data["_metadata"])}</div>`;
            delete data["_metadata"];
          }

          $(`#${id}`).append(`<div><b>${location}${cache}</b>: ${JSON.stringify(data)}${metadata}</div>`);
        })
        .fail(function (data) {
          $(`#${id}`).append(`<div><b>${location} <span style="color: red">(ERROR)</b>: ${JSON.stringify(data)}</div>`);
        })
      }

      function MIX_urbana(id) { MIX("Urbana", "40.11242414744814,-88.22848937852949", id); }
      function MIX_chicago(id) { MIX("Chicago", "41.87576819343849,-87.61944465318383", id); }
      function MIX_sanfran(id) { MIX("San Francisco", "37.75882502706528,-122.41911451006501", id); }
      function MIX_nyc(id) { MIX("NYC", "40.75666771839337,-73.98625913328931", id); }
      function MIX_paris(id) { MIX("Paris", "48.857930123894434,2.295098552370449", id); }
      function MIX_shenzhen(id) { MIX("Shenzhen", "22.540561272953067,114.05948186832616", id); }
      function MIX_ocean(id) { MIX("Pacific Ocean", "-34.958471835673606,176.51926400734376", id); }

      function sendPOST() {

        let formData = { location: document.getElementById("displayLat").innerText
                        + ',' + document.getElementById("displayLng").innerText};

        $.post("/MIX", formData)
        .done(function (data) {
          clearTiles();
          data.forEach(element =>createTile(element));
          rearrangeTiles();
        })
        .fail(function (data) {
          clearTiles();
          $("#content").html(`<hr><h3>Error - ${data.status}</h3><pre>${JSON.stringify(data, null, 2)}</pre>`);
        })
      };
    </script>
    <style>
      h1 { text-align: center; }
      .mix {
        font-weight: bold;
        font-size: 120%;
        line-height: 80%;
        height: 80%;
        background: -webkit-linear-gradient(#13294B, #FF552E, #13294B, #FF552E);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
    </style>
  </head>
  <body>
    <main class="container">
      <h1><span class="mix">MIX</span></h1>
      <hr>
      <button onclick="getConnected();" class="btn btn-secondary">Refresh Connected Clients</button>
      <hr>
      <div id="connected"></div>
    </main>
  </body>
</html>